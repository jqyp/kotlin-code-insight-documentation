# Testing

## The Kotlin Compiler DevKit plugin

You may want to install the [Kotlin Compiler DevKit](https://plugins.jetbrains.com/plugin/27616-kotlin-compiler-devkit) plugin.
It simplifies running and navigating tests, along with other testing-related tasks in the IDE.

## K2 quick-fix test generator

K2 quick-fix tests are generated by
[`GenerateK2QuickFixTests.kt`](https://github.com/JetBrains/intellij-community/blob/c10144aa9f57a309a60edec8267829d10c1e8b7b/plugins/kotlin/util/test-generator-fir/test/org/jetbrains/kotlin/fir/testGenerator/codeinsight/GenerateK2QuickFixTests.kt#L13).  
The generator maps `testData` directories to generated test methods.

## Generating test classes

Use the run configuration **`Generate Kotlin Tests (K1 + K2)`** to regenerate test classes from `testData`.  
This keeps K1/K2 JUnit test classes in sync with test files.  
Re-run **Generate Kotlin Tests (K1 + K2)** whenever you add, rename, or move files in `testData`.

## Directives

Tests often rely on directives written as comments inside test data files. These directives control the test framework
behavior, declare expectations (such as diagnostics or available actions), and configure the test environment (e.g.,
language version, runtime, inspections).

The following table lists the most commonly used directives and their meaning:

| Directive                          | Description                                                                                                                                                                                                                   |
|------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `IGNORE_K1`                        | Marks a test as ignored for K1.<br>If the directive is present but the test succeeds in K1, the test fails with:<br><code>java.lang.AssertionError: Looks like the test passes, please remove // IGNORE_K1 from <file></code> |
| `IGNORE_K2`                        | Marks a test as ignored for K2.<br>If the directive is present but the test succeeds in K2, the test fails with:<br><code>java.lang.AssertionError: Looks like the test passes, please remove // IGNORE_K2 from <file></code> |
| `ERROR: <message>`                 | Declares an expected diagnostic in K1 (FE10). Messages must match exactly (text & punctuation).                                                                                                                               |
| `K2_ERROR: <message>`              | Declares an expected diagnostic in K2 (FIR). **All actual K2 diagnostics must be listed; no extras.** Messages must match exactly.                                                                                            |
| `AFTER_ERROR: <message>`           | K1 “after” diagnostic expectation (used when the expected message differs in the post-state).                                                                                                                                 |
| `K2_AFTER_ERROR: <message>`        | K2 “after” diagnostic expectation (used when the expected message differs in the post-state).                                                                                                                                 |
| `ACTION: <presentation>`           | Lists an expected **available** intention/quick-fix at caret (one per line). Compared by visible presentation text. In K2 mode this directive **is also recognized** (see `actionsListDirectives`).                           |
| `K2_ACTIONS_LIST: <presentation>`  | Same as `ACTION:` but K2-specific. In K2 mode, both `K2_ACTIONS_LIST:` and `ACTION:` are accepted and compared against available actions.                                                                                     |
| `KEEP_ACTIONS_LIST_ORDER`          | Checks that actions appear **in the same order** as listed (uses `IntentionsOrderProvider`). Without it, lists are compared sorted.                                                                                           |
| `IGNORE_IRRELEVANT_ACTIONS`        | **Skips action availability checking entirely** (early return). Useful to avoid flakes due to environment-dependent “irrelevant” items.                                                                                       |
| `FILE: <path>`                     | Starts a new virtual file section for multi-file tests.                                                                                                                                                                       |
| `WITH_STDLIB`                      | Adds the Kotlin standard library to the test module classpath.                                                                                                                                                                |
| `RUNTIME_WITH_FULL_JDK`            | Runs tests with a full JDK runtime (not a mock/minimal JDK).                                                                                                                                                                  |
| `PRIORITY: LOW/NORMAL/HIGH/TOP`    | Declares the expected quick-fix priority. <br><note>If it differs from `NORMAL`, it is good practice to use this directive.</note>                                                                                            |
| `DISABLE_ERRORS`                   | Disables error checks (`ERROR`/`K2_ERROR`) for the file.                                                                                                                                                                      |
| `DISABLE_WARNINGS`                 | Disables warning checks (when warnings would otherwise be enabled).                                                                                                                                                           |
| `ENABLE_WARNINGS`                  | Enables warning checks (warnings are **disabled by default** unless this is present).                                                                                                                                         |
| `LANGUAGE_VERSION`                 | Sets the Kotlin language version (e.g., `1.8`, `2.0`).                                                                                                                                                                        |
| `COMPILER_ARGUMENTS`               | Extra compiler flags for the test module (e.g., `-XXLanguage:+TrailingCommas`).                                                                                                                                               |
| `COMPILER_PLUGIN_OPTIONS`          | Options for compiler plugins (e.g., `plugin:org.example:option=value`).                                                                                                                                                       |
| `INSPECTION-CLASS: <fqcn>`         | Runs the given inspection class(es) against the file (fully-qualified class names).                                                                                                                                           |
| `INSPECTION: [...]`                | Lines used to declare the **expected** inspection output format (the test compares to these).                                                                                                                                 |
| `NO-INSPECTION-OUTPUT`             | Required when inspection run produces **no output**; otherwise the test fails if both actual and expected are empty.                                                                                                          |
